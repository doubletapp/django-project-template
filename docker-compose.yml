version: "3.4"

x-logging: &x-logging
  driver: journald
  options:
    tag: "{{.Name}}"

services:
  db:
    container_name: project_name__db
    image: ${IMAGE_DB}
    build: ./postgres
    command: postgres -c 'max_connections=1000'

    volumes: ["db_volume:/var/lib/postgresql/data/"]

    ports: 
      - 54321:5432

    logging: *x-logging
    restart: always

  app:
    container_name: project_name__app
    image: ${IMAGE_APP}
    build: ./src

    env_file: .env
    volumes: ["static_volume:/src/static/"]
    depends_on: ["db"]

    logging: *x-logging
    restart: always

  nginx:
    container_name: project_name__nginx
    image: ${IMAGE_NGINX}
    build: ./nginx

    volumes: ["static_volume:/src/static/", "nginx_log_volume:/var/log/nginx/"]
    ports: ["${PORT}:80"]

    logging: *x-logging
    restart: always

  nginx-exporter:
    container_name: project_name__nginx-exporter
    image: ${IMAGE_NGINX_EXPORTER}
    build: ./nginx-exporter

    volumes: ["nginx_log_volume:/var/log/nginx/"]

    logging: *x-logging
    restart: always

  swagger:
    container_name: project_name__swagger
    image: ${IMAGE_SWAGGER}
    build: ./swagger

    logging: *x-logging
    restart: always

volumes:
  db_volume:
  static_volume:
  nginx_log_volume:
